window.bbcode={};
window.bbcode.parse=function(f,r){function d(a,d){return{bbtag:a,etag:d}}function t(e,f,n,b,c,h,m){if(f&&f.length){if(!k)return e;switch(f){case "\r":return"";case "\n":return"<br>"}}if(n&&n.length&&s.test(n)){c=n.toLowerCase();if(l||a.length&&("url"==a[a.length-1].bbtag||"link"==a[a.length-1].bbtag)&&0<=g)return"["+n+"]";switch(c){case "code":return a.push(new d(c,"</code></pre>")),k=!1,"<pre><code>";case "pre":return a.push(new d(c,"</pre>")),k=!1,"<pre>";case "center":return a.push(new d(c,"</center>")),
k=!1,"<center>";case "color":case "colour":return b&&u.test(b)||(b="inherit"),a.push(new d(c,"</span>")),'<span style="color: '+b+'">';case "size":return b&&v.test(b)||(b="1"),a.push(new d(c,"</span>")),'<span style="font-size: '+Math.min(Math.max(b,.7),3)+'em">';case "s":return a.push(new d(c,"</span>")),'<span style="text-decoration: line-through">';case "noparse":return l=!0,"";case "link":case "url":a.push(new d(c,"</a>"));if(b&&p.test(b))return g=-1,'<a target="_blank" href="'+b+'">';g=e.length+
h;return'<a target="_blank" href="';case "img":return a.push(new d(c,'" />')),b&&p.test(b)?(g=-1,"<"+c+' src="'+b+""):"<"+c+' src="';case "q":case "quote":case "blockquote":return h="q"===c?"q":"blockquote",a.push(new d(c,"</"+h+">")),b&&b.length&&p.test(b)?"<"+h+' cite="'+b+'">':"<"+h+">";case "list":return a.push(new d("list","</ol>")),"<ol>";case "ulist":return a.push(new d("ulist","</ul>")),"<ul>";case "b":return a.push(new d("b","</strong>")),"<strong>";case "i":return a.push(new d("i","</em>")),
"<em>";default:return a.push(new d(c,"</"+c+">")),"<"+c+">"}}if(c&&c.length&&s.test(c)){b=c.toLowerCase();if(l)return"noparse"==c?(l=!1,""):"[/"+c+"]";if(!a.length||a[a.length-1].bbtag!=b)return'<span style="color: red">[/'+c+"]</span>";if("url"==b||"link"==b){if(0<g)return'">'+m.substr(g,h-g)+a.pop().etag}else if("code"==b||"pre"==b)k=!0;return a.pop().etag}return e}var a=[],k=!0,l=!1,g=-1,s=/^\/?(?:b|i|u|pre|center|samp|code|colou?r|size|noparse|url|link|s|q|(block)?quote|img|u?list|li)$/i,u=/^(:?black|silver|gray|white|maroon|red|purple|fuchsia|green|lime|olive|yellow|navy|blue|teal|aqua|#(?:[0-9a-f]{3})?[0-9a-f]{3})$/i,
v=/^[\\.0-9]{1,8}$/i,p=/^[-;\/\?:@&=\+\$,_\.!~\*'\(\)%0-9a-z]{1,512}$/i,m=/([\r\n])|(?:\[([a-z]{1,16})(?:=(?:"|'|)([^\x00-\x1F"'\(\)<>\[\]]{1,256}))?(?:"|'|)\])|(?:\[\/([a-z]{1,16})\])/ig,q="",e,k=!0;if(null==a||a.length)a=[];if(f&&(f=function(a){return a.replace(/(\[\*\])([^\[]*)/g,function(a,d,b,c,e){return"[li]"+b+"[/li]"})}(f),q=f.replace(m,t),l&&(l=!1),a.length)){e=new String;if("url"==a[a.length-1].bbtag||"link"==a[a.length-1].bbtag)a.pop(),e+='">'+f.substr(g,f.length-g)+"</a>";for(;a.length;)e+=
a.pop().etag}m=e?q+e:q;if(r)r(m);else return m};
